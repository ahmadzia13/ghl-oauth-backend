<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>OAuth Login</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f7f7f7;
    display: flex;
    height: 100vh;
    justify-content: center;
    align-items: center;
  }
  .box {
    background: white;
    padding: 20px;
    border-radius: 10px;
    width: 400px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  input, button, select {
    width: 100%;
    padding: 10px;
    margin: 8px 0;
    border: 1px solid #ccc;
    border-radius: 5px;
  }
  button {
    background: #4CAF50;
    color: white;
    border: none;
    cursor: pointer;
  }
  button:hover {
    background: #45a049;
  }
  .tags-container {
    display: flex;
    flex-wrap: wrap;
    border: 1px solid #ccc;
    padding: 5px;
    border-radius: 5px;
    min-height: 40px;
    cursor: text;
  }
  .tag {
    background: #e0e0e0;
    padding: 5px 10px;
    margin: 3px;
    border-radius: 3px;
    display: flex;
    align-items: center;
  }
  .tag span {
    margin-left: 5px;
    cursor: pointer;
  }
  .tag-input {
    border: none;
    flex: 1;
    padding: 5px;
    min-width: 120px;
    outline: none;
  }
  .client-selector {
    margin-bottom: 15px;
  }
  .hidden {
    display: none;
  }
</style>
</head>
<body>
  <div class="box">
    <h2>OAuth Login</h2>
    
    <div class="client-selector">
      <select id="clientSelect" onchange="handleClientSelect()">
        <option value="">Select an existing client or add new</option>
      </select>
      <button onclick="loadClients()">Refresh Client List</button>
    </div>
    
    <div id="clientForm">
      <input type="text" id="clientId" placeholder="Client ID" required>
      <input type="text" id="clientSecret" placeholder="Client Secret" required>
    </div>

    <div class="tags-container" id="tagsContainer">
      <input type="text" class="tag-input" id="tagInput" placeholder="Type and press Enter">
    </div>

    <button onclick="startAuth()">Authenticate</button>
  </div>

<script>
  const maxTags = 60;
  const tagsContainer = document.getElementById('tagsContainer');
  const tagInput = document.getElementById('tagInput');
  
  // Pre-fill with your 5 scopes
  const tags = [
    "contacts.readonly",
    "contacts.write",
    "conversations.readonly",
    "businesses.readonly",
    "calendars.readonly"
  ];

  function createTag(label) {
    const div = document.createElement('div');
    div.classList.add('tag');
    div.textContent = label;

    const span = document.createElement('span');
    span.textContent = 'Ã—';
    span.onclick = () => removeTag(label);
    div.appendChild(span);

    tagsContainer.insertBefore(div, tagInput);
  }

  function removeTag(label) {
    const index = tags.indexOf(label);
    tags.splice(index, 1);
    updateTags();
  }

  function updateTags() {
    tagsContainer.querySelectorAll('.tag').forEach(tag => tag.remove());
    tags.forEach(createTag);
  }

  // Render pre-filled tags on page load
  updateTags();

  tagInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && tagInput.value.trim() !== '') {
      e.preventDefault();
      if (tags.length >= maxTags) {
        alert('Maximum 60 scopes allowed');
        return;
      }
      const value = tagInput.value.trim();
      if (!tags.includes(value)) {
        tags.push(value);
        updateTags();
      }
      tagInput.value = '';
    }
  });

  // Load clients from the server
  async function loadClients() {
    try {
      const res = await fetch("/clients");
      const clients = await res.json();
      
      const select = document.getElementById("clientSelect");
      // Clear existing options except the first one
      select.innerHTML = '<option value="">Select an existing client or add new</option>';
      
      // Add clients to the dropdown
      clients.forEach(client => {
        const option = document.createElement("option");
        option.value = JSON.stringify({clientId: client.clientId, clientSecret: client.clientSecret});
        option.textContent = `${client.clientId} (${client.locationId})`;
        select.appendChild(option);
      });
    } catch (err) {
      console.error("Error loading clients:", err);
      alert("Error loading clients");
    }
  }

  // Handle client selection
  function handleClientSelect() {
    const select = document.getElementById("clientSelect");
    const clientForm = document.getElementById("clientForm");
    
    if (select.value) {
      // Hide the form when a client is selected
      clientForm.classList.add("hidden");
      
      // Fill the form fields with selected client data
      const client = JSON.parse(select.value);
      document.getElementById("clientId").value = client.clientId;
      document.getElementById("clientSecret").value = client.clientSecret;
    } else {
      // Show the form when "add new" is selected
      clientForm.classList.remove("hidden");
      document.getElementById("clientId").value = "";
      document.getElementById("clientSecret").value = "";
    }
  }

  async function startAuth() {
    const clientId = document.getElementById("clientId").value.trim();
    const clientSecret = document.getElementById("clientSecret").value.trim();

    if (!clientId || !clientSecret || tags.length === 0) {
      alert("Please fill all fields and add at least one scope");
      return;
    }

    const res = await fetch("/initiate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ clientId, clientSecret, scopes: tags })
    });

    const data = await res.json();
    if (data.url) {
      window.location.href = data.url;
    } else {
      alert("Error: " + JSON.stringify(data));
    }
  }

  // Load clients when the page loads
  window.onload = function() {
    loadClients();
  };
</script>

</body>
</html>
